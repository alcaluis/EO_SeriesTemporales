---
title: "series_temporales_2.pdf"
author:
  - "ALBACETE CABALLERO, LUIS"
  - "SEBASTIA GARCIA, SERGIO"
  - "SELMA GRACIA, PABLO"
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
rm(list=ls())

# Carga de datos y librerias
library(lubridate)
library(tidyr)
library(lomb)
library(ggplot2)
library(forecast)
tg <- read.table("./data/TG_STAID000455.txt", header = TRUE, sep = ",", skip = 20)
```

# Ejercicio 1

Realizar gráficos que describan la serie original. Comprobar mediante algún método gráfico si existe estacionalidad anual.

```{r ej1}
### SERIE ORIGINAL
df_tg <- tg %>%
  # Retirar valores faltantes
  filter(Q_TG != 9) %>%
  mutate(DATE = ymd(DATE),
         TG = TG / 10,
         YEAR = format(DATE, "%Y"),
         MONTH = format(DATE, "%m"),
         DAY_N = as.numeric(format(DATE, "%d"))) %>%
  select(-STAID)

plot(df_tg$DATE, df_tg$TG,
     type = "l",
     xlab = "Fecha",
     ylab = "Temp. media (Celsius)",
     main = "Temperatura estación TENERIFE/LOS RODEOS, SPAIN")

df_tg_13_23 <- df_tg %>%
  filter(YEAR %in% 2013:2023)

plot(df_tg_13_23$DATE, df_tg_13_23$TG,
     type = "l",
     xlab = "Fecha",
     ylab = "Temp. media (Celsius)",
     main = "Temperatura estación TENERIFE/LOS RODEOS, SPAIN (2013 a 2023)",
     col = "lightblue")

### Mostramos estacionalidad anual
ggplot(df_tg, aes(x = MONTH, y = TG)) +
  geom_boxplot(fill = "lightblue", color = "black") +
  labs(title = "Boxplot Mensual de TG", x = "Mes", y = "Temperatura (TG)")
```

# Ejercicio 2

¿Parece que hay tendencia? Estimar la tendencia utilizando un modelo lineal y un filtro de media móvil (teniendo cuidado con los valores NA).

```{r ej2}
df_tg$DATE_N <- as.numeric(df_tg$DATE)
modelo_lineal <- lm(TG ~ DATE_N, data = df_tg) 

### MEDIAS MOVILES
ma_tg <- forecast::ma(df_tg$TG, 365)

ggplot(df_tg, aes(x = DATE, y = ma_tg)) +
  geom_line() +
  ggtitle("Gráfica Medias Movibles y modelo lineal") +
  xlab("Fecha") +
  ylab("Medias Movibles (k=365)") +
  stat_smooth(method = "lm", col = "red", size = 2, alpha = 0.5) +
  geom_line(aes(y = predict(modelo_lineal)), colour = "blue", size = 1)

# WIP: Agregar leyenda
```

Apreciamos que mediante ambos, un modelo lineal y el uso de las medias móviles, la tendencia de la temperatura es positiva con el paso del tiempo.

# Ejercicio 3

Analizar la varianza: ¿parece ser constante?

```{r ej3}
df_tg_est_varianza <- df_tg %>%
  mutate(YEAR = as.numeric(YEAR)) %>%
  group_by(YEAR) %>%
  summarise(var_TG = sd(TG)**2)

ggplot(df_tg_est_varianza, aes(x = YEAR)) +
  geom_line(aes(y = var_TG), color = "purple", size = 1) +
  labs(title = "Serie Temporal de TG con Varianza", x = "Fecha", y = "Temperatura (TG)")
```
Como podemos comprobar la varianza no es constante con el paso de los años. Basándonos en la heterocedasticidad podemos concluir que la serie es "no estacionaria".

# Ejercicio 4

Antes de continuar con el análisis, transformar la serie temporal en una serie regular con una frecuencia fija (el problema es que distintos años tienen diferentes números de días). Para ello, agregamos la serie temporal en 36 puntos por año, promediando los días de cada mes en
tres periodos de aproximadamente 10 días. Es decir, para cada mes se promedian (con la media) las observaciones en tres periodos: desde el 1 hasta el 10, desde el 11 hasta el 20, y desde el 21 hasta el final del mes (este último periodo puede tener una longitud variable). Las funciones "summarise" en combinación con "group by" del paquete dplyr pueden ser útiles para esta operación.

```{r ej4}
df_tg_frec_fija <- df_tg %>%
  mutate(PERIOD = case_when(DAY_N <= 10 ~ "1", 
                            DAY_N <= 20 ~ "2",
                            TRUE ~ "3")) %>%
  group_by(YEAR, MONTH, PERIOD) %>%
  summarise(mean_p_TG = mean(TG), .groups="keep")
```

# Ejercicio 5

Descomponer la serie en tendencia, estacionalidad y residuos. Estudiar los residuos y la tendencia.

```{r ej5}

```

# Ejercicio 6

¿Hay evidencia del cambio climático en estas observaciones? Es decir, ¿parece haber un calentamiento a lo largo del tiempo? Responder analizando la información obtenida hasta ahora y, eventualmente, utilizando otros métodos.

```{r ej6}

```

# Ejercicio 7

Considerando la información hasta el año 2010, construir un modelo predictivo para la temperatura en la década 2010-2020. Contrastar la predicción obtenida con los datos observados. Comparar distintos modelos predictivos y evaluarlos en cuanto a su capacidad para predecir la temperatura de la d´ecada 2010-2020.

```{r ej7}

```

# Ejercicio 8

Proporcionar una estimación de la temperatura hasta el año 2030. En particular, proporcionar una estimación de la temperatura para todos los meses del año 2030. Utilizar el mejor modelo obtenido en el punto anterior. Intentar también proporcionar una estimación de la confianza o incertidumbre de las predicciones.

```{r ej8}

```